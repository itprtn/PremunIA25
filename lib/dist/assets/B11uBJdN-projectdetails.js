import{a as e,j as s,P as t,e as a,h as r}from"./dfWdBlna-chunk.js";import{r as l}from"./Dc2Emx3F-chunk.js";import{w as n,u as i,B as c,D as d,g as o,h as m,i as x,C as u,m as h,n as j,a as p,f as g,r as v,S as N,b as f,c as b,d as y,e as w,I as _,t as k,s as S,L as C,T as E,j as R,k as L,l as D}from"./lYxdVFoR.js";import{P as I}from"./Z_xDiygn-chunk.js";import{d as q,v as F,U as A,q as P,H as T,y as O,k as H,j as V,E as $,a1 as z,u as M,a2 as B,e as W,O as G,a3 as J,t as K,i as U,a4 as Q,P as X,K as Y,T as Z,a5 as ee}from"./7YIM3tny-chunk.js";import{c as se,u as te}from"./DHnlrK-p-chunk.js";import"./BpqZfnrR-chunk.js";import"./Bo41tin1-chunk.js";var ae={exports:{}},re={},le=l;var ne="function"==typeof Object.is?Object.is:function(e,s){return e===s&&(0!==e||1/e==1/s)||e!=e&&s!=s},ie=le.useState,ce=le.useEffect,de=le.useLayoutEffect,oe=le.useDebugValue;function me(e){var s=e.getSnapshot;e=e.value;try{var t=s();return!ne(e,t)}catch(a){return!0}}var xe="undefined"==typeof window||void 0===window.document||void 0===window.document.createElement?function(e,s){return s()}:function(e,s){var t=s(),a=ie({inst:{value:t,getSnapshot:s}}),r=a[0].inst,l=a[1];return de(function(){r.value=t,r.getSnapshot=s,me(r)&&l({inst:r})},[e,t,s]),ce(function(){return me(r)&&l({inst:r}),e(function(){me(r)&&l({inst:r})})},[e]),oe(t),t};re.useSyncExternalStore=void 0!==le.useSyncExternalStore?le.useSyncExternalStore:xe,ae.exports=re;var ue=ae.exports;function he(){return()=>{}}var je="Avatar",[pe,ge]=e(je),[ve,Ne]=pe(je),fe=l.forwardRef((e,a)=>{const{__scopeAvatar:r,...n}=e,[i,c]=l.useState("idle");return s.jsx(ve,{scope:r,imageLoadingStatus:i,onImageLoadingStatusChange:c,children:s.jsx(t.span,{...n,ref:a})})});fe.displayName=je;var be="AvatarImage",ye=l.forwardRef((e,n)=>{const{__scopeAvatar:i,src:c,onLoadingStatusChange:d=()=>{},...o}=e,m=Ne(be,i),x=function(e,{referrerPolicy:s,crossOrigin:t}){const a=ue.useSyncExternalStore(he,()=>!0,()=>!1),n=l.useRef(null),i=a?(n.current||(n.current=new window.Image),n.current):null,[c,d]=l.useState(()=>ke(i,e));return r(()=>{d(ke(i,e))},[i,e]),r(()=>{const e=e=>()=>{d(e)};if(!i)return;const a=e("loaded"),r=e("error");return i.addEventListener("load",a),i.addEventListener("error",r),s&&(i.referrerPolicy=s),"string"==typeof t&&(i.crossOrigin=t),()=>{i.removeEventListener("load",a),i.removeEventListener("error",r)}},[i,t,s]),c}(c,o),u=a(e=>{d(e),m.onImageLoadingStatusChange(e)});return r(()=>{"idle"!==x&&u(x)},[x,u]),"loaded"===x?s.jsx(t.img,{...o,ref:n,src:c}):null});ye.displayName=be;var we="AvatarFallback",_e=l.forwardRef((e,a)=>{const{__scopeAvatar:r,delayMs:n,...i}=e,c=Ne(we,r),[d,o]=l.useState(void 0===n);return l.useEffect(()=>{if(void 0!==n){const e=window.setTimeout(()=>o(!0),n);return()=>window.clearTimeout(e)}},[n]),d&&"loaded"!==c.imageLoadingStatus?s.jsx(t.span,{...i,ref:a}):null});function ke(e,s){return e?s?(e.src!==s&&(e.src=s),e.complete&&e.naturalWidth>0?"loaded":"loading"):"error":"idle"}_e.displayName=we;var Se=fe,Ce=ye,Ee=_e;const Re=l.forwardRef(({className:e,...t},a)=>s.jsx(Se,{ref:a,className:n("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",e),...t}));Re.displayName=Se.displayName;const Le=l.forwardRef(({className:e,...t},a)=>s.jsx(Ce,{ref:a,className:n("aspect-square h-full w-full",e),...t}));Le.displayName=Ce.displayName;const De=l.forwardRef(({className:e,...t},a)=>s.jsx(Ee,{ref:a,className:n("flex h-full w-full items-center justify-center rounded-full bg-muted",e),...t}));function Ie({projectId:e,contactId:t,contactEmail:a,contactName:r,mode:n="individual",onEmailSent:C}){const[E,R]=l.useState(!1),[L,D]=l.useState([]),[I,T]=l.useState(""),[O,H]=l.useState({to:a||"",subject:"",html:"",text:""}),[V,$]=l.useState(!1),[z,M]=l.useState(!1),{toast:B}=i(),W=e=>e.replace(/\{prenom\}/g,(null==r?void 0:r.split(" ")[0])||"").replace(/\{nom\}/g,(null==r?void 0:r.split(" ").slice(1).join(" "))||"").replace(/\{civilite\}/g,"Monsieur/Madame").replace(/\{email\}/g,a||"");return s.jsxs(s.Fragment,{children:[s.jsxs(c,{onClick:()=>{R(!0),(async()=>{if(!z)try{const{data:e,error:s}=await S.from("email_templates").select("id, nom, sujet, contenu_html").eq("statut","actif").order("nom");if(s)throw s;D(e||[]),M(!0)}catch(e){console.error("Error loading templates:",e),B({title:"Erreur",description:"Impossible de charger les templates email",variant:"destructive"})}})()},className:"flex items-center space-x-2",variant:"individual"===n?"outline":"default",children:["individual"===n?s.jsx(q,{className:"w-4 h-4"}):s.jsx(F,{className:"w-4 h-4"}),s.jsx("span",{children:"individual"===n?"Envoyer Email":"Campagne Email"})]}),s.jsx(d,{open:E,onOpenChange:R,children:s.jsxs(o,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[s.jsx(m,{children:s.jsxs(x,{className:"flex items-center space-x-2",children:["individual"===n?s.jsx(A,{className:"w-5 h-5"}):s.jsx(F,{className:"w-5 h-5"}),s.jsx("span",{children:"individual"===n?"Envoyer Email Individuel":"Créer Campagne Email"})]})}),s.jsxs("div",{className:"space-y-6",children:["individual"===n&&s.jsxs(u,{children:[s.jsx(h,{className:"pb-3",children:s.jsx(j,{className:"text-sm",children:"Destinataire"})}),s.jsx(p,{children:s.jsxs("div",{className:"flex items-center space-x-4",children:[s.jsx(g,{variant:"outline",children:r||"Contact"}),s.jsx(g,{variant:"secondary",children:a})]})})]}),s.jsxs("div",{className:"space-y-3",children:[s.jsx(v,{htmlFor:"template",children:"Template Email (optionnel)"}),s.jsxs(N,{value:I,onValueChange:e=>{const s=L.find(s=>s.id.toString()===e);s&&H({...O,subject:s.sujet,html:s.contenu_html,text:s.contenu_html.replace(/<[^>]*>/g,"")}),T(e)},children:[s.jsx(f,{children:s.jsx(b,{placeholder:"Choisir un template ou créer un email personnalisé"})}),s.jsx(y,{children:L.map(e=>s.jsxs(w,{value:e.id.toString(),children:[e.nom," - ",e.sujet]},e.id))})]})]}),s.jsxs("div",{className:"grid grid-cols-1 gap-4",children:["campaign"===n&&s.jsxs("div",{children:[s.jsx(v,{htmlFor:"to",children:"Email Destinataire"}),s.jsx(_,{id:"to",type:"email",placeholder:"email@example.com",value:O.to,onChange:e=>H({...O,to:e.target.value})})]}),s.jsxs("div",{children:[s.jsx(v,{htmlFor:"subject",children:"Sujet *"}),s.jsx(_,{id:"subject",value:O.subject,onChange:e=>H({...O,subject:e.target.value}),placeholder:"Sujet de votre email..."})]}),s.jsxs("div",{children:[s.jsx(v,{htmlFor:"html",children:"Contenu HTML *"}),s.jsx(k,{id:"html",rows:12,value:O.html,onChange:e=>H({...O,html:e.target.value}),placeholder:"Contenu HTML de votre email...",className:"font-mono text-sm"})]}),s.jsxs("div",{children:[s.jsx(v,{htmlFor:"text",children:"Contenu Texte (optionnel)"}),s.jsx(k,{id:"text",rows:4,value:O.text,onChange:e=>H({...O,text:e.target.value}),placeholder:"Version texte (générée automatiquement si vide)"})]})]}),s.jsx(u,{className:"bg-blue-50 dark:bg-blue-950",children:s.jsxs(p,{className:"pt-4",children:[s.jsx("h4",{className:"font-medium mb-2",children:"Variables disponibles :"}),s.jsxs("div",{className:"text-sm text-muted-foreground space-x-4",children:[s.jsx("code",{children:"{prenom}"}),s.jsx("code",{children:"{nom}"}),s.jsx("code",{children:"{civilite}"}),s.jsx("code",{children:"{email}"})]})]})}),s.jsxs("div",{className:"flex justify-end space-x-3",children:[s.jsx(c,{variant:"outline",onClick:()=>R(!1),children:"Annuler"}),s.jsx(c,{onClick:async()=>{if(O.to&&O.subject&&O.html){$(!0);try{const s={to:O.to,subject:W(O.subject),html:W(O.html),text:W(O.text||O.html.replace(/<[^>]*>/g,""))},{data:a,error:r}=await S.functions.invoke("send-email",{body:s});if(r)throw r;if(!(null==a?void 0:a.success))throw new Error((null==a?void 0:a.error)||"Erreur d'envoi");(e||t)&&await S.from("email_history").insert({project_id:e,contact_id:t,destinataire:O.to,sujet:s.subject,status:"sent",message_id:a.messageId,sent_at:(new Date).toISOString()}),B({title:"Email envoyé !",description:`Email envoyé avec succès à ${O.to}`}),R(!1),null==C||C()}catch(s){console.error("❌ Erreur envoi email:",s),B({title:"Erreur d'envoi",description:s.message||"Impossible d'envoyer l'email",variant:"destructive"})}finally{$(!1)}}else B({title:"Erreur",description:"Veuillez remplir tous les champs obligatoires",variant:"destructive"})},disabled:V||!O.subject||!O.html,className:"flex items-center space-x-2",children:V?s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"animate-spin",children:"⏳"}),s.jsx("span",{children:"Envoi..."})]}):s.jsxs(s.Fragment,{children:[s.jsx(P,{className:"w-4 h-4"}),s.jsx("span",{children:"Envoyer Email"})]})})]})]})]})})]})}function qe({projectId:e}){var t,a,r,n;const[i,c]=l.useState(null),[d,o]=l.useState([]),[m,x]=l.useState(!0);l.useEffect(()=>{v(),N()},[e]);const v=async()=>{try{const{data:s,error:t}=await S.from("projets").select("\n          *,\n          contact:contact_id (\n            identifiant,\n            prenom,\n            nom,\n            email,\n            civilite\n          )\n        ").eq("projet_id",e).single();if(t)throw t;c(s)}catch(s){console.error("Error loading project:",s)}finally{x(!1)}},N=async()=>{try{const{data:s,error:t}=await S.from("email_history").select("*").eq("project_id",e).order("sent_at",{ascending:!1}).limit(10);if(t)throw t;o(s||[])}catch(s){console.error("Error loading email history:",s)}},f=e=>{switch(e){case"sent":return s.jsx(g,{className:"bg-green-100 text-green-800",children:"Envoyé"});case"opened":return s.jsx(g,{className:"bg-blue-100 text-blue-800",children:"Ouvert"});case"clicked":return s.jsx(g,{className:"bg-purple-100 text-purple-800",children:"Cliqué"});case"failed":return s.jsx(g,{className:"bg-red-100 text-red-800",children:"Échec"});default:return s.jsx(g,{variant:"outline",children:e})}};return m?s.jsx("div",{className:"flex justify-center p-8",children:"Chargement..."}):i?s.jsxs("div",{className:"space-y-6",children:[s.jsxs(u,{children:[s.jsx(h,{children:s.jsxs(j,{className:"flex items-center space-x-2",children:[s.jsx(q,{className:"w-5 h-5"}),s.jsx("span",{children:"Communication Email"})]})}),s.jsx(p,{children:s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium mb-3",children:"Contact Principal"}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsxs("span",{className:"font-medium",children:[null==(t=i.contact)?void 0:t.prenom," ",null==(a=i.contact)?void 0:a.nom]}),s.jsx(g,{variant:"outline",children:i.statut})]}),s.jsxs("div",{className:"text-sm text-muted-foreground",children:["📧 ",(null==(r=i.contact)?void 0:r.email)||"Aucun email"]}),s.jsxs("div",{className:"text-sm text-muted-foreground",children:["📅 Créé le ",new Date(i.date_creation||i.created_at).toLocaleDateString("fr-FR")]})]})]}),s.jsx("div",{className:"flex flex-col justify-center",children:(null==(n=i.contact)?void 0:n.email)?s.jsx(Ie,{projectId:e,contactId:i.contact.identifiant,contactEmail:i.contact.email,contactName:`${i.contact.prenom} ${i.contact.nom}`,mode:"individual",onEmailSent:N}):s.jsx("div",{className:"text-center p-4 bg-orange-50 rounded-lg",children:s.jsx("p",{className:"text-orange-600",children:"Aucun email disponible pour ce contact"})})})]})})]}),s.jsxs(u,{children:[s.jsx(h,{children:s.jsxs(j,{className:"flex items-center space-x-2",children:[s.jsx(T,{className:"w-5 h-5"}),s.jsx("span",{children:"Historique des Emails"}),s.jsx(g,{variant:"outline",children:d.length})]})}),s.jsx(p,{children:0===d.length?s.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[s.jsx(q,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),s.jsx("p",{children:"Aucun email envoyé pour ce projet"})]}):s.jsx("div",{className:"space-y-3",children:d.map(e=>s.jsxs("div",{className:"p-4 border rounded-lg",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsx("div",{className:"font-medium truncate",children:e.sujet}),f(e.status)]}),s.jsxs("div",{className:"text-sm text-muted-foreground",children:[s.jsxs("div",{className:"flex items-center space-x-4",children:[s.jsxs("span",{children:["📧 ",e.destinataire]}),s.jsxs("span",{className:"flex items-center space-x-1",children:[s.jsx(O,{className:"w-3 h-3"}),s.jsx("span",{children:new Date(e.sent_at).toLocaleString("fr-FR")})]})]}),e.opened_at&&s.jsxs("div",{className:"mt-1 text-blue-600",children:["👁 Ouvert le ",new Date(e.opened_at).toLocaleString("fr-FR")]}),e.clicked_at&&s.jsxs("div",{className:"mt-1 text-purple-600",children:["🖱 Cliqué le ",new Date(e.clicked_at).toLocaleString("fr-FR")]})]})]},e.id))})})]})]}):s.jsx("div",{className:"text-center p-8",children:"Projet non trouvé"})}De.displayName=Ee.displayName;const Fe=({projectId:e})=>{const[t,a]=l.useState([]),[r,n]=l.useState(!0),[i,d]=l.useState(!1),[o,m]=l.useState({total:0,delivre:0,ouvert:0,clic:0,openRate:0,clickRate:0});l.useEffect(()=>{x()},[e]);const x=async()=>{try{const{data:s,error:t}=await S.from("envois_email").select("\n          id,\n          destinataire,\n          statut,\n          date_envoi,\n          date_ouverture,\n          date_clic,\n          contact_id,\n          campagne_id\n        ").eq("projet_id",e).in("statut",["envoye","delivre"]).not("date_envoi","is",null).order("date_envoi",{ascending:!1});if(t)throw t;a([]);const r=s.length,l=s.filter(e=>"delivre"===e.statut).length,n=(s.filter(e=>"envoye"===e.statut).length,s.filter(e=>"ouvert"===e.statut).length),i=s.filter(e=>"clic"===e.statut).length;if(m({total:r,delivre:l,ouvert:n,clic:i,openRate:l>0?n/l*100:0,clickRate:l>0?i/l*100:0}),s.length>0){const e=s.map(e=>({id:e.id,destinataire:e.destinataire,statut:e.statut,date_envoi:e.date_envoi,date_ouverture:e.date_ouverture,date_clic:e.date_clic,contact_nom:"",contact_prenom:"",campagne_nom:""}));a(e)}}catch(s){console.error("Erreur lors de la récupération de l'historique:",s)}finally{n(!1)}},v=e=>{switch(e){case"envoye":return s.jsx(P,{className:"h-4 w-4 text-blue-500"});case"delivre":return s.jsx(q,{className:"h-4 w-4 text-green-500"});case"ouvert":return s.jsx($,{className:"h-4 w-4 text-yellow-500"});case"clic":return s.jsx(z,{className:"h-4 w-4 text-purple-500"});case"bounce":return s.jsx(M,{className:"h-4 w-4 text-red-500"});default:return s.jsx(q,{className:"h-4 w-4 text-gray-500"})}},N=e=>{switch(e){case"envoye":return"bg-blue-100 text-blue-800";case"delivre":return"bg-green-100 text-green-800";case"ouvert":return"bg-yellow-100 text-yellow-800";case"clic":return"bg-purple-100 text-purple-800";case"bounce":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}},f=e=>e?new Date(e).toLocaleString("fr-FR"):"N/A";return r?s.jsx(u,{children:s.jsx(p,{className:"flex items-center justify-center py-8",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})})}):s.jsxs("div",{className:"space-y-4",children:[s.jsxs(u,{children:[s.jsx(h,{children:s.jsxs(j,{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx("span",{children:"📧 Suivi des Emails"}),s.jsxs(g,{variant:"outline",className:"text-xs",children:[o.total," emails"]})]}),s.jsxs(c,{variant:"outline",size:"sm",onClick:()=>d(!i),children:[i?s.jsx(H,{className:"h-4 w-4"}):s.jsx(V,{className:"h-4 w-4"}),i?"Masquer":"Afficher"]})]})}),s.jsxs(p,{children:[s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-4",children:[s.jsxs("div",{className:"text-center p-3 bg-blue-50 rounded-lg",children:[s.jsx("div",{className:"text-2xl font-bold text-blue-600",children:o.total}),s.jsx("div",{className:"text-sm text-blue-700",children:"Emails envoyés"}),s.jsx("div",{className:"text-xs text-blue-600",children:"Total traités"})]}),s.jsxs("div",{className:"text-center p-3 bg-green-50 rounded-lg",children:[s.jsx("div",{className:"text-2xl font-bold text-green-600",children:o.delivre}),s.jsx("div",{className:"text-sm text-green-700",children:"Délivrés"}),s.jsx("div",{className:"text-xs text-green-600",children:"Reçus par destinataire"})]}),s.jsxs("div",{className:"text-center p-3 bg-yellow-50 rounded-lg",children:[s.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:o.ouvert}),s.jsx("div",{className:"text-sm text-yellow-700",children:"Ouverts"}),s.jsx("div",{className:"text-xs text-yellow-600",children:"Consultés par destinataire"})]}),s.jsxs("div",{className:"text-center p-3 bg-purple-50 rounded-lg",children:[s.jsx("div",{className:"text-2xl font-bold text-purple-600",children:o.clic}),s.jsx("div",{className:"text-sm text-purple-700",children:"Clics"}),s.jsx("div",{className:"text-xs text-purple-600",children:"Liens cliqués"})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex justify-between text-sm",children:[s.jsx("span",{children:"Taux d'ouverture:"}),s.jsxs("span",{className:"font-medium",children:[o.openRate.toFixed(1),"%"]})]}),s.jsx(I,{value:o.openRate,className:"h-2"}),s.jsxs("div",{className:"flex justify-between text-sm",children:[s.jsx("span",{children:"Taux de clic:"}),s.jsxs("span",{className:"font-medium",children:[o.clickRate.toFixed(1),"%"]})]}),s.jsx(I,{value:o.clickRate,className:"h-2"})]})]})]}),i&&s.jsxs(u,{children:[s.jsx(h,{children:s.jsxs(j,{className:"flex items-center space-x-2",children:[s.jsx("span",{children:"Détail des Emails Envoyés"}),s.jsx(g,{variant:"secondary",className:"text-xs",children:"Tri chronologique ↓"})]})}),s.jsx(p,{children:s.jsxs("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:[t.map((e,t)=>s.jsxs("div",{className:"border rounded-lg p-3 bg-white hover:bg-gray-50 transition-colors",children:[s.jsxs("div",{className:"flex items-center justify-between mb-3",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-sm font-bold text-blue-600",children:t+1}),v(e.statut),s.jsxs("div",{children:[s.jsx("div",{className:"font-medium text-gray-900",children:e.destinataire}),e.contact_prenom&&e.contact_nom&&s.jsxs("div",{className:"text-sm text-gray-600",children:[e.contact_prenom," ",e.contact_nom]})]})]}),s.jsx(g,{className:N(e.statut),children:e.statut})]}),s.jsxs("div",{className:"text-right",children:[s.jsx("div",{className:"text-sm font-medium text-gray-900",children:f(e.date_envoi)}),s.jsx("div",{className:"text-xs text-gray-500",children:"Envoyé"})]})]}),e.campagne_nom&&s.jsx("div",{className:"mb-3",children:s.jsxs("span",{className:"inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs",children:["📧 Campagne: ",e.campagne_nom]})}),s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-2 gap-3 text-sm",children:[s.jsx("div",{className:"p-2 rounded "+(e.date_ouverture?"bg-green-50 border border-green-200":"bg-gray-50 border border-gray-200"),children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx($,{className:"h-4 w-4 "+(e.date_ouverture?"text-green-600":"text-gray-400")}),s.jsx("span",{className:e.date_ouverture?"text-green-700":"text-gray-500",children:e.date_ouverture?f(e.date_ouverture):"Non ouvert"})]})}),s.jsx("div",{className:"p-2 rounded "+(e.date_clic?"bg-purple-50 border border-purple-200":"bg-gray-50 border border-gray-200"),children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(z,{className:"h-4 w-4 "+(e.date_clic?"text-purple-600":"text-gray-400")}),s.jsx("span",{className:e.date_clic?"text-purple-700":"text-gray-500",children:e.date_clic?f(e.date_clic):"Non cliqué"})]})})]})]},e.id)),0===t.length&&s.jsxs("div",{className:"text-center py-8 text-gray-500",children:[s.jsx(q,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),s.jsx("p",{children:"Aucun email trouvé pour ce projet"})]})]})})]})]})};function Ae(){var e,t,a,r,n;const{id:i}=se(),d=te(),[o,m]=l.useState(null),[x,v]=l.useState(!0);l.useEffect(()=>{i&&N(i)},[i]);const N=async e=>{try{v(!0);const{data:s,error:t}=await S.from("projets").select("*, contact:contact_id(*)").eq("projet_id",e).single();if(t)return console.error("Error fetching project:",t),void d("/projects");const{data:a,error:r}=await S.from("contrats").select("*").eq("projet_id",e).maybeSingle(),{data:l,error:n}=await S.from("interactions").select("*").eq("contact_id",s.contact_id).order("created_at",{ascending:!1});m({projet:s,contact:s.contact,contrat:a,interactions:l||[]})}catch(s){console.error("Error loading project data:",s),d("/projects")}finally{v(!1)}},f=e=>{const s=null==e?void 0:e.toLowerCase();switch(!0){case null==s?void 0:s.includes("contrat enregistré"):return"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200";case null==s?void 0:s.includes("devis envoyé"):return"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200";case(null==s?void 0:s.includes("en cours"))||(null==s?void 0:s.includes("projet à traiter")):return"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200";case(null==s?void 0:s.includes("perdu"))||(null==s?void 0:s.includes("inexploitable")):return"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200";case(null==s?void 0:s.includes("ne repond pas"))||(null==s?void 0:s.includes("ne répond pas")):return"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200";default:return"bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200"}},b=e=>{const s=null==e?void 0:e.toLowerCase();switch(!0){case null==s?void 0:s.includes("nouveau"):return 20;case(null==s?void 0:s.includes("projet à traiter"))||(null==s?void 0:s.includes("en cours")):return 40;case null==s?void 0:s.includes("devis envoyé"):return 70;case null==s?void 0:s.includes("contrat enregistré"):return 100;default:return 10}};if(x)return s.jsx(C,{title:"Chargement...",children:s.jsx("div",{className:"flex justify-center items-center p-8",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})})});if(!o)return s.jsx(C,{title:"Projet non trouvé",children:s.jsxs("div",{className:"text-center p-8",children:[s.jsx(M,{className:"w-16 h-16 text-muted-foreground mx-auto mb-4"}),s.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Projet non trouvé"}),s.jsx("p",{className:"text-muted-foreground mb-4",children:"Ce projet n'existe pas ou a été supprimé."}),s.jsxs(c,{onClick:()=>d("/projects"),children:[s.jsx(B,{className:"w-4 h-4 mr-2"}),"Retour aux projets"]})]})});const{projet:y,contact:w,contrat:_,interactions:k}=o;return s.jsx(C,{title:`Projet #${y.projet_id}`,children:s.jsxs("div",{className:"space-y-6",children:[s.jsxs(c,{variant:"ghost",onClick:()=>d("/projects"),className:"flex items-center space-x-2 rounded-xl",children:[s.jsx(B,{className:"w-4 h-4"}),s.jsx("span",{children:"Retour aux projets"})]}),s.jsxs("div",{className:"bg-gradient-to-r from-primary/10 to-blue-600/10 rounded-2xl p-6",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4",children:[s.jsxs("div",{className:"flex items-center space-x-4",children:[s.jsx("div",{className:"w-16 h-16 bg-gradient-to-r from-primary to-blue-600 rounded-2xl flex items-center justify-center",children:s.jsx(W,{className:"w-8 h-8 text-white"})}),s.jsxs("div",{children:[s.jsxs("h1",{className:"text-3xl font-bold",children:["Projet #",y.projet_id]}),s.jsx("p",{className:"text-muted-foreground text-lg",children:y.type})]})]}),s.jsx(g,{className:`px-4 py-2 text-sm font-medium rounded-full ${f(y.statut??"")}`,children:y.statut})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex justify-between text-sm",children:[s.jsx("span",{className:"text-muted-foreground",children:"Progression du projet"}),s.jsxs("span",{className:"font-medium",children:[b(y.statut??""),"%"]})]}),s.jsx(I,{value:b(y.statut??""),className:"h-3"})]})]}),s.jsxs(E,{defaultValue:"resume",className:"w-full",children:[s.jsxs(R,{className:"grid w-full grid-cols-5 mb-8 rounded-2xl",children:[s.jsxs(L,{value:"resume",className:"flex items-center space-x-2 rounded-xl",children:[s.jsx(W,{className:"w-4 h-4"}),s.jsx("span",{children:"Résumé"})]}),s.jsxs(L,{value:"contact",className:"flex items-center space-x-2 rounded-xl",children:[s.jsx(A,{className:"w-4 h-4"}),s.jsx("span",{children:"Contact"})]}),s.jsxs(L,{value:"contrat",className:"flex items-center space-x-2 rounded-xl",children:[s.jsx(G,{className:"w-4 h-4"}),s.jsx("span",{children:"Contrat"})]}),s.jsxs(L,{value:"communications",className:"flex items-center space-x-2 rounded-xl",children:[s.jsx(J,{className:"w-4 h-4"}),s.jsxs("span",{children:["Communications (",k.length,")"]})]}),s.jsxs(L,{value:"tracking",className:"flex items-center space-x-2 rounded-xl",children:[s.jsx(q,{className:"w-4 h-4"}),s.jsx("span",{children:"📧 Suivi Email"})]})]}),s.jsx(D,{value:"resume",className:"space-y-6",children:s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[s.jsxs(u,{className:"rounded-2xl border-0 shadow-md hover:shadow-lg transition-all duration-300",children:[s.jsx(h,{children:s.jsxs(j,{className:"flex items-center",children:[s.jsx(W,{className:"w-5 h-5 mr-2"}),"Informations Projet"]})}),s.jsxs(p,{className:"space-y-4",children:[s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"ID Projet"}),s.jsx("p",{className:"font-semibold text-lg",children:y.projet_id})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"Type"}),s.jsx("p",{className:"font-semibold",children:y.type})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"Origine"}),s.jsx(g,{variant:"outline",className:"rounded-full",children:y.origine})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"Commercial"}),s.jsx("p",{className:"font-semibold",children:y.commercial})]})]}),y.notes&&s.jsxs("div",{className:"pt-4 border-t",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[s.jsx(K,{className:"w-5 h-5 text-primary"}),s.jsx("p",{className:"text-sm font-medium text-foreground",children:"Notes & Commentaires"}),s.jsx(g,{variant:"secondary",className:"text-xs",children:"Interne"})]}),s.jsx("div",{className:"bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-xl p-4",children:s.jsx("p",{className:"text-sm text-blue-900 dark:text-blue-100 leading-relaxed whitespace-pre-wrap",children:y.notes})})]}),s.jsxs("div",{className:"pt-4 border-t",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[s.jsx($,{className:"w-5 h-5 text-primary"}),s.jsx("p",{className:"text-sm font-medium text-foreground",children:"Informations Système"})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs",children:[s.jsxs("div",{className:"bg-gray-50 dark:bg-gray-900 p-3 rounded-lg",children:[s.jsx("p",{className:"text-muted-foreground mb-1",children:"Contact ID"}),s.jsx("p",{className:"font-mono text-gray-900 dark:text-gray-100",children:y.contact_id})]}),s.jsxs("div",{className:"bg-gray-50 dark:bg-gray-900 p-3 rounded-lg",children:[s.jsx("p",{className:"text-muted-foreground mb-1",children:"Projet ID"}),s.jsx("p",{className:"font-mono text-gray-900 dark:text-gray-100",children:y.projet_id})]}),s.jsxs("div",{className:"bg-gray-50 dark:bg-gray-900 p-3 rounded-lg",children:[s.jsx("p",{className:"text-muted-foreground mb-1",children:"Création interne"}),s.jsx("p",{className:"font-mono text-gray-900 dark:text-gray-100",children:new Date(y.created_at).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})})]}),s.jsxs("div",{className:"bg-gray-50 dark:bg-gray-900 p-3 rounded-lg",children:[s.jsx("p",{className:"text-muted-foreground mb-1",children:"Dernière MAJ"}),s.jsx("p",{className:"font-mono text-gray-900 dark:text-gray-100",children:new Date(y.updated_at).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})})]})]})]})]})]}),s.jsxs(u,{className:"rounded-2xl border-0 shadow-md hover:shadow-lg transition-all duration-300",children:[s.jsx(h,{children:s.jsxs(j,{className:"flex items-center",children:[s.jsx(U,{className:"w-5 h-5 mr-2"}),"Chronologie"]})}),s.jsxs(p,{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center space-x-3",children:[s.jsx("div",{className:"w-3 h-3 bg-green-500 rounded-full"}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium",children:"Créé le"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:new Date(y.date_creation??"").toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"})})]})]}),y.commercial&&s.jsxs("div",{className:"flex items-center space-x-3",children:[s.jsx("div",{className:"w-3 h-3 bg-purple-500 rounded-full"}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium",children:"Commercial assigné"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:y.commercial})]})]})]})]})]})}),s.jsx(D,{value:"contact",className:"space-y-6",children:w?s.jsxs(u,{className:"rounded-2xl border-0 shadow-md hover:shadow-lg transition-all duration-300",children:[s.jsx(h,{children:s.jsxs("div",{className:"flex items-center space-x-4",children:[s.jsxs(Re,{className:"h-16 w-16",children:[s.jsx(Le,{src:`https://api.dicebear.com/6.x/initials/svg?seed=${w.prenom} ${w.nom}`}),s.jsxs(De,{className:"text-xl",children:[null==(e=w.prenom)?void 0:e[0],null==(t=w.nom)?void 0:t[0]]})]}),s.jsxs("div",{children:[s.jsxs(j,{className:"text-2xl",children:[w.prenom," ",w.nom]}),w.civilite&&s.jsx("p",{className:"text-muted-foreground",children:w.civilite})]})]})}),s.jsx(p,{children:s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[s.jsxs("div",{className:"space-y-4",children:[s.jsxs("h3",{className:"font-semibold text-lg flex items-center",children:[s.jsx(A,{className:"w-5 h-5 mr-2"}),"Informations Personnelles"]}),w.raison_sociale&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(G,{className:"w-4 h-4 text-muted-foreground"}),s.jsx("span",{className:"font-medium",children:w.raison_sociale})]}),w.siret&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx("span",{className:"text-sm text-muted-foreground",children:"SIRET:"}),s.jsx("span",{className:"font-medium",children:w.siret})]})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsx("h3",{className:"font-semibold text-lg",children:"Contact"}),w.email&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(q,{className:"w-4 h-4 text-muted-foreground"}),s.jsx("span",{children:w.email})]}),w.telephone&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(Q,{className:"w-4 h-4 text-muted-foreground"}),s.jsx("span",{children:w.telephone})]}),(w.adresse||w.ville)&&s.jsxs("div",{className:"flex items-start space-x-2",children:[s.jsx(X,{className:"w-4 h-4 text-muted-foreground mt-1"}),s.jsxs("div",{children:[w.adresse&&s.jsx("div",{children:w.adresse}),(w.code_postal||w.ville)&&s.jsxs("div",{children:[w.code_postal," ",w.ville]})]})]})]})]})})]}):s.jsx(u,{className:"rounded-2xl border-0 shadow-md",children:s.jsxs(p,{className:"text-center py-12",children:[s.jsx(A,{className:"w-16 h-16 text-muted-foreground mx-auto mb-4"}),s.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Aucun contact associé"}),s.jsx("p",{className:"text-muted-foreground",children:"Ce projet n'a pas de contact associé."})]})})}),s.jsx(D,{value:"contrat",className:"space-y-6",children:_?s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[s.jsxs(u,{className:"rounded-2xl border-0 shadow-md hover:shadow-lg transition-all duration-300",children:[s.jsx(h,{children:s.jsxs(j,{className:"flex items-center",children:[s.jsx(G,{className:"w-5 h-5 mr-2"}),"Informations Contrat"]})}),s.jsx(p,{className:"space-y-4",children:s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"Statut"}),s.jsx(g,{className:f(_.contrat_statut||""),children:_.contrat_statut||"Non spécifié"})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"Compagnie"}),s.jsx("p",{className:"font-semibold",children:_.contrat_compagnie||"Non spécifiée"})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"Produit"}),s.jsx("p",{className:"font-semibold",children:_.contrat_produit||"Non spécifié"})]}),_.contrat_formule&&s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"Formule"}),s.jsx("p",{className:"font-semibold",children:_.contrat_formule})]})]})})]}),s.jsxs(u,{className:"rounded-2xl border-0 shadow-md hover:shadow-lg transition-all duration-300",children:[s.jsx(h,{children:s.jsxs(j,{className:"flex items-center",children:[s.jsx(Y,{className:"w-5 h-5 mr-2"}),"Détails Financiers"]})}),s.jsxs(p,{className:"space-y-4",children:[s.jsxs("div",{className:"flex justify-between items-center p-3 bg-green-50 rounded-xl",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"Prime Brute Annuelle"}),s.jsxs("p",{className:"text-2xl font-bold text-green-600",children:["€",(null==(a=_.prime_brute_annuelle)?void 0:a.toLocaleString())||"0"]})]}),s.jsx(Z,{className:"w-8 h-8 text-green-600"})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[s.jsxs("div",{className:"p-3 bg-blue-50 rounded-xl",children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"Prime Nette"}),s.jsxs("p",{className:"text-lg font-bold text-blue-600",children:["€",(null==(r=_.prime_nette_annuelle)?void 0:r.toLocaleString())||"0"]})]}),s.jsxs("div",{className:"p-3 bg-purple-50 rounded-xl",children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"Commission"}),s.jsxs("p",{className:"text-lg font-bold text-purple-600",children:["€",(null==(n=_.commissionnement_annee1)?void 0:n.toLocaleString())||"0"]})]})]})]})]})]}):s.jsx(u,{className:"rounded-2xl border-0 shadow-md",children:s.jsxs(p,{className:"text-center py-12",children:[s.jsx(G,{className:"w-16 h-16 text-muted-foreground mx-auto mb-4"}),s.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Aucun contrat associé"}),s.jsx("p",{className:"text-muted-foreground mb-4",children:"Ce projet n'a pas encore de contrat enregistré."}),s.jsx(c,{variant:"outline",className:"rounded-xl",children:"Créer un contrat"})]})})}),s.jsxs(D,{value:"communications",className:"space-y-6",children:[s.jsxs(u,{className:"rounded-2xl border-0 shadow-md hover:shadow-lg transition-all duration-300",children:[s.jsx(h,{children:s.jsxs(j,{className:"flex items-center",children:[s.jsx(J,{className:"w-5 h-5 mr-2"}),"Historique des Communications (",k.length,")"]})}),s.jsx(p,{children:k.length>0?s.jsx("div",{className:"space-y-4 max-h-96 overflow-y-auto",children:k.map(e=>s.jsxs("div",{className:"flex items-start space-x-3 p-4 bg-muted/30 rounded-xl",children:[s.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(g,{variant:"outline",className:"capitalize",children:e.type||"Communication"}),e.canal&&s.jsx(g,{variant:"secondary",className:"text-xs",children:e.canal})]}),s.jsx("span",{className:"text-xs text-muted-foreground",children:e.created_at&&new Date(e.created_at).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})})]}),e.sujet&&s.jsx("h4",{className:"font-medium text-sm mb-1",children:e.sujet}),e.message&&s.jsx("p",{className:"text-sm text-muted-foreground",children:e.message}),e.workflow_name&&s.jsxs("div",{className:"flex items-center space-x-1 mt-2",children:[s.jsx("span",{className:"text-xs text-blue-600 font-medium",children:"Workflow:"}),s.jsx("span",{className:"text-xs text-blue-600",children:e.workflow_name})]})]})]},e.id))}):s.jsxs("div",{className:"text-center py-8",children:[s.jsx(J,{className:"w-12 h-12 text-muted-foreground mx-auto mb-3"}),s.jsx("p",{className:"text-muted-foreground",children:"Aucune communication pour ce projet"})]})})]}),s.jsx(qe,{projectId:y.projet_id})]}),s.jsxs(D,{value:"tracking",className:"space-y-6",children:[s.jsxs(u,{className:"rounded-2xl border-0 shadow-md",children:[s.jsxs(h,{children:[s.jsxs(j,{className:"flex items-center",children:[s.jsx(q,{className:"w-5 h-5 mr-2 text-blue-600"}),"Actions de Suivi Email"]}),s.jsx("p",{className:"text-sm text-muted-foreground",children:"Gérez les communications et consultez l'historique pour ce projet"})]}),s.jsx(p,{children:s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[s.jsxs(c,{variant:"outline",className:"h-auto p-4 flex flex-col items-center space-y-2 hover:bg-blue-50 hover:border-blue-300",onClick:()=>{const e=document.querySelector('[data-value="communications"]');e&&e.click&&e.click()},children:[s.jsx(K,{className:"w-8 h-8 text-blue-600"}),s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"font-medium",children:"Nouvel Email"}),s.jsx("div",{className:"text-xs text-muted-foreground",children:"Envoyer un message personnalisé"})]})]}),s.jsxs(c,{variant:"outline",className:"h-auto p-4 flex flex-col items-center space-y-2 hover:bg-green-50 hover:border-green-300",onClick:()=>{window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})},children:[s.jsx(T,{className:"w-8 h-8 text-green-600"}),s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"font-medium",children:"Historique Complet"}),s.jsx("div",{className:"text-xs text-muted-foreground",children:"Voir tous les envois"})]})]}),s.jsxs(c,{variant:"outline",className:"h-auto p-4 flex flex-col items-center space-y-2 hover:bg-purple-50 hover:border-purple-300",onClick:()=>{window.open(`/campaigns?project=${y.projet_id}`,"_blank")},children:[s.jsx(ee,{className:"w-8 h-8 text-purple-600"}),s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"font-medium",children:"Voir Campagnes"}),s.jsx("div",{className:"text-xs text-muted-foreground",children:"Campagnes liées"})]})]})]})})]}),s.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-950/20 dark:to-indigo-950/20 rounded-2xl p-6",children:[s.jsxs("div",{className:"flex items-center justify-between mb-6",children:[s.jsxs("div",{className:"text-center flex-1",children:[s.jsx(q,{className:"w-16 h-16 mx-auto mb-4 text-blue-600"}),s.jsx("h3",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100 mb-2",children:"Suivi Email Détaillé"}),s.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Historique complet des emails et interactions pour ce projet"})]}),s.jsxs("div",{className:"flex flex-col items-end space-y-2",children:[s.jsxs(c,{variant:"secondary",size:"sm",children:[s.jsx($,{className:"w-4 h-4 mr-2"}),"Affichage détail"]}),s.jsxs(c,{variant:"outline",size:"sm",children:[s.jsx(T,{className:"w-4 h-4 mr-2"}),"Filtrer par date"]})]})]}),s.jsx(Fe,{projectId:y.projet_id})]})]})]})]})})}export{Ae as default};
