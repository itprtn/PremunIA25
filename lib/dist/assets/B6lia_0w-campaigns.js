import{j as e}from"./dfWdBlna-chunk.js";import{r as s}from"./Dc2Emx3F-chunk.js";import{u as t,s as a,C as r,a as l,I as n,S as i,b as c,c as d,d as o,e as m,B as x,f as u,D as h,g as j,h as g,i as v,T as p,j as N,k as f,l as b,m as _,n as w,o as y,L as E}from"./lYxdVFoR.js";import{P as C}from"./Z_xDiygn-chunk.js";import{n as D,d as S,q as B,u as T,T as G,i as L,v as U,t as q,E as R,m as I,f as k,w as F,x as M,y as A,z as P,H as O}from"./7YIM3tny-chunk.js";import{u as H}from"./DHnlrK-p-chunk.js";import"./BpqZfnrR-chunk.js";import"./Bo41tin1-chunk.js";function V(){var y,E;const{toast:H}=t(),[V,z]=s.useState([]),[$,W]=s.useState([]),[K,Q]=s.useState(""),[Y,J]=s.useState("all"),[X,Z]=s.useState("all"),[ee,se]=s.useState("all"),[te,ae]=s.useState("all"),[re,le]=s.useState("all"),[ne,ie]=s.useState("all"),[ce,de]=s.useState(!0),[oe,me]=s.useState(null),[xe,ue]=s.useState([]),[he,je]=s.useState(!1),[ge,ve]=s.useState(!1),[pe,Ne]=s.useState(!1),[fe,be]=s.useState(!1),[_e,we]=s.useState([]),[ye,Ee]=s.useState(null);s.useEffect(()=>{Ce()},[]);const Ce=async()=>{try{de(!0);const{data:e,error:s}=await a.from("envois_groupes").select("*").order("created_at",{ascending:!1});if(s)throw console.error("ðŸ” DEBUG: Error loading envois_groupes:",s),console.error("ðŸ” DEBUG: Error code:",s.code),console.error("ðŸ” DEBUG: Error message:",s.message),s;null==e||e.length,null==e||e[0];const{data:t,error:r}=await a.from("email_templates").select("id, nom, sujet");if(r)throw console.error("ðŸ” DEBUG: Error loading email_templates:",r),r;null==t||t.length,z(e||[]),W(t||[])}catch(e){console.error("ðŸ” DEBUG: Final error in loadData:",e),H({title:"Erreur",description:"Impossible de charger l'historique des envois",variant:"destructive"})}finally{de(!1)}},De=s.useMemo(()=>{V.length;const e=V.filter(e=>{var s,t;const a=!K||e.nom_campagne.toLowerCase().includes(K.toLowerCase())||(null==(s=e.commercial)?void 0:s.toLowerCase().includes(K.toLowerCase()));a&&0;const r=new Date(e.created_at),l=new Date,n="all"===X||"today"===X&&r.toDateString()===l.toDateString()||"week"===X&&r>=new Date(l.getTime()-6048e5)||"month"===X&&r>=new Date(l.getTime()-2592e6);n&&0;const i=e.nombre_echecs>0,c="all"===Y||"success"===Y&&!i||"errors"===Y&&i;c&&0;const d="all"===ee||"none"===ee&&!e.template_id||e.template_id&&(null==(t=$.find(s=>s.id===e.template_id))?void 0:t.nom)===ee,o="all"===te||e.commercial===te,m=e.nombre_destinataires>0?Math.round((e.nombre_envoyes-e.nombre_echecs)/e.nombre_destinataires*100):0,x="all"===re||"excellent"===re&&m>=90||"good"===re&&m>=70&&m<90||"average"===re&&m>=50&&m<70||"poor"===re&&m<50,u="all"===ne||"small"===ne&&e.nombre_destinataires<50||"medium"===ne&&e.nombre_destinataires>=50&&e.nombre_destinataires<200||"large"===ne&&e.nombre_destinataires>=200,h=a&&n&&c&&d&&o&&x&&u;return h&&0,h});return K&&V.forEach(e=>{var s;const t=e.nom_campagne.toLowerCase().includes(K.toLowerCase()),a=null==(s=e.commercial)?void 0:s.toLowerCase().includes(K.toLowerCase());(t||a)&&(e.id,e.nom_campagne,e.commercial)}),e.length,e},[V,K,X,Y,ee,te,re,ne,$]),Se=s.useMemo(()=>{const e=De.length,s=De.reduce((e,s)=>e+s.nombre_envoyes,0),t=De.reduce((e,s)=>e+s.nombre_echecs,0),a=s>0?(s-t)/s*100:0;return{totalCampaigns:e,totalSent:s,totalErrors:t,successRate:Math.round(100*a)/100}},[De]),Be=e=>0===e.nombre_echecs?"bg-green-100 text-green-800 border-green-200":e.nombre_echecs===e.nombre_destinataires?"bg-red-100 text-red-800 border-red-200":"bg-yellow-100 text-yellow-800 border-yellow-200",Te=e=>0===e.nombre_echecs?"SuccÃ¨s complet":e.nombre_echecs===e.nombre_destinataires?"Ã‰chec total":"SuccÃ¨s partiel",Ge=e=>{switch(e){case"envoye":return"bg-green-100 text-green-800";case"echec":return"bg-red-100 text-red-800";case"ouvert":return"bg-blue-100 text-blue-800";case"clique":return"bg-purple-100 text-purple-800";default:return"bg-gray-100 text-gray-800"}};return ce?e.jsx("div",{className:"flex justify-center items-center p-12",children:e.jsx(D,{className:"h-8 w-8 animate-spin text-primary"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Historique des Envois GroupÃ©s"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Suivi dÃ©taillÃ© des campagnes emails avec statistiques Brevo"})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsx(r,{className:"border-0 bg-gradient-to-br from-blue-50 to-blue-100",children:e.jsxs(l,{className:"p-6 text-center",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-2 mb-2",children:[e.jsx(S,{className:"w-6 h-6 text-blue-600"}),e.jsx("div",{className:"text-3xl font-bold text-blue-600",children:Se.totalCampaigns})]}),e.jsx("div",{className:"text-sm text-blue-700 font-medium",children:"Campagnes Totales"})]})}),e.jsx(r,{className:"border-0 bg-gradient-to-br from-green-50 to-green-100",children:e.jsxs(l,{className:"p-6 text-center",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-2 mb-2",children:[e.jsx(B,{className:"w-6 h-6 text-green-600"}),e.jsx("div",{className:"text-3xl font-bold text-green-600",children:Se.totalSent})]}),e.jsx("div",{className:"text-sm text-green-700 font-medium",children:"Emails EnvoyÃ©s"})]})}),e.jsx(r,{className:"border-0 bg-gradient-to-br from-red-50 to-red-100",children:e.jsxs(l,{className:"p-6 text-center",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-2 mb-2",children:[e.jsx(T,{className:"w-6 h-6 text-red-600"}),e.jsx("div",{className:"text-3xl font-bold text-red-600",children:Se.totalErrors})]}),e.jsx("div",{className:"text-sm text-red-700 font-medium",children:"Ã‰checs"})]})}),e.jsx(r,{className:"border-0 bg-gradient-to-br from-purple-50 to-purple-100",children:e.jsxs(l,{className:"p-6 text-center",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-2 mb-2",children:[e.jsx(G,{className:"w-6 h-6 text-purple-600"}),e.jsxs("div",{className:"text-3xl font-bold text-purple-600",children:[Se.successRate,"%"]})]}),e.jsx("div",{className:"text-sm text-purple-700 font-medium",children:"Taux de SuccÃ¨s"})]})})]}),e.jsx(r,{children:e.jsxs(l,{className:"p-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-4",children:[e.jsx(n,{placeholder:"Rechercher une campagne...",value:K,onChange:e=>Q(e.target.value)}),e.jsxs(i,{value:Y,onValueChange:J,children:[e.jsx(c,{children:e.jsx(d,{placeholder:"Statut"})}),e.jsxs(o,{children:[e.jsx(m,{value:"all",children:"Tous les statuts"}),e.jsx(m,{value:"success",children:"SuccÃ¨s complet"}),e.jsx(m,{value:"errors",children:"Avec erreurs"})]})]}),e.jsxs(i,{value:X,onValueChange:Z,children:[e.jsx(c,{children:e.jsx(d,{placeholder:"PÃ©riode"})}),e.jsxs(o,{children:[e.jsx(m,{value:"all",children:"Toutes les pÃ©riodes"}),e.jsx(m,{value:"today",children:"Aujourd'hui"}),e.jsx(m,{value:"week",children:"Cette semaine"}),e.jsx(m,{value:"month",children:"Ce mois"})]})]}),e.jsxs(i,{value:ee,onValueChange:se,children:[e.jsx(c,{children:e.jsx(d,{placeholder:"Template"})}),e.jsxs(o,{children:[e.jsx(m,{value:"all",children:"Tous les templates"}),e.jsx(m,{value:"none",children:"Sans template"}),$.map(s=>e.jsx(m,{value:s.nom,children:s.nom},s.id))]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-4",children:[e.jsxs(i,{value:te,onValueChange:ae,children:[e.jsx(c,{children:e.jsx(d,{placeholder:"Commercial"})}),e.jsxs(o,{children:[e.jsx(m,{value:"all",children:"Tous les commerciaux"}),[...new Set(V.map(e=>e.commercial).filter(Boolean))].map(s=>e.jsx(m,{value:s,children:s},s))]})]}),e.jsxs(i,{value:re,onValueChange:le,children:[e.jsx(c,{children:e.jsx(d,{placeholder:"Taux de succÃ¨s"})}),e.jsxs(o,{children:[e.jsx(m,{value:"all",children:"Tous les taux"}),e.jsx(m,{value:"excellent",children:"Excellent (â‰¥90%)"}),e.jsx(m,{value:"good",children:"Bon (70-89%)"}),e.jsx(m,{value:"average",children:"Moyen (50-69%)"}),e.jsx(m,{value:"poor",children:"Faible (moins de 50%)"})]})]}),e.jsxs(i,{value:ne,onValueChange:ie,children:[e.jsx(c,{children:e.jsx(d,{placeholder:"Nombre destinataires"})}),e.jsxs(o,{children:[e.jsx(m,{value:"all",children:"Tous les nombres"}),e.jsx(m,{value:"small",children:"Petit (moins de 50)"}),e.jsx(m,{value:"medium",children:"Moyen (50-199)"}),e.jsx(m,{value:"large",children:"Grand (â‰¥200)"})]})]}),e.jsx(x,{variant:"outline",onClick:()=>{Q(""),J("all"),Z("all"),se("all"),ae("all"),le("all"),ie("all")},children:"RÃ©initialiser tous"})]})]})}),e.jsx("div",{className:"grid gap-4",children:De.map(s=>{const t=$.find(e=>e.id===s.template_id),n=s.nombre_destinataires>0?Math.round((s.nombre_envoyes-s.nombre_echecs)/s.nombre_destinataires*100):0;return e.jsx(r,{className:"hover:shadow-md transition-all duration-200",children:e.jsx(l,{className:"p-6",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("h3",{className:"text-lg font-semibold",children:s.nom_campagne}),e.jsx(u,{className:Be(s),children:Te(s)})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-4",children:[e.jsxs("div",{className:"text-center p-3 bg-gray-50 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-700",children:s.nombre_destinataires}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Destinataires"})]}),e.jsxs("div",{className:"text-center p-3 bg-green-50 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:s.nombre_envoyes}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"EnvoyÃ©s"})]}),e.jsxs("div",{className:"text-center p-3 bg-red-50 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:s.nombre_echecs}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Ã‰checs"})]}),e.jsxs("div",{className:"text-center p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"text-2xl font-bold text-blue-600",children:[n,"%"]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"SuccÃ¨s"})]})]}),s.nombre_destinataires>0&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex justify-between text-sm mb-2",children:[e.jsx("span",{children:"Progression"}),e.jsxs("span",{children:[s.nombre_envoyes,"/",s.nombre_destinataires]})]}),e.jsx(C,{value:s.nombre_envoyes/s.nombre_destinataires*100,className:"h-2"})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(L,{className:"h-4 w-4"}),new Date(s.created_at).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})]}),t&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(S,{className:"h-4 w-4"}),t.nom]}),s.commercial&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(U,{className:"h-4 w-4"}),s.commercial]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>(async e=>{try{be(!0),me(e),e.id;const{data:s,error:t}=await a.from("envois_email").select("id, campagne_id, contact_id, projet_id, destinataire, sujet, contenu_html, contenu_texte, statut, date_envoi, date_ouverture, date_clic, created_at").eq("campagne_id",e.id).order("created_at",{ascending:!1});if(t)throw console.error("ðŸ” DEBUG: Error loading emails:",t),t;if(null==s||s.length,s&&s.length>0){const e=new Map,t=[...new Set(s.map(e=>e.projet_id).filter(Boolean))];if(t.length>0){const{data:r,error:l}=await a.from("projets").select("\n              projet_id,\n              statut,\n              commercial,\n              origine,\n              contact:contact_id (\n                identifiant,\n                prenom,\n                nom,\n                email\n              )\n            ").in("projet_id",t);l?console.error("ðŸ” DEBUG: Error loading projects:",l):(null==r||r.length,null==r||r.forEach(t=>{const a=s.filter(e=>e.projet_id===t.projet_id);e.set(t.projet_id,{project:t,emails:a})}))}const r=Array.from(e.values()).map(({project:e,emails:s})=>({project:e,emails:s,emailCount:s.length,sentCount:s.filter(e=>"envoye"===e.statut).length,openedCount:s.filter(e=>"ouvert"===e.statut).length,clickedCount:s.filter(e=>"clique"===e.statut).length,errorCount:s.filter(e=>"echec"===e.statut).length}));r.length,we(r),Ne(!0)}else H({title:"Aucun email trouvÃ©",description:"Cette campagne ne contient aucun email.",variant:"destructive"})}catch(s){console.error("ðŸ” DEBUG: Error in loadProjectEmailHistory:",s),H({title:"Erreur",description:"Impossible de charger l'historique des emails par projet",variant:"destructive"})}finally{be(!1)}})(s),disabled:fe,className:"gap-2",children:[e.jsx(q,{className:"h-4 w-4"}),"Emails par projet"]}),e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>(async e=>{try{ve(!0),me(e),e.id;const{data:s,error:t}=await a.from("envois_email").select("id, contact_id, destinataire").eq("campagne_id",e.id).limit(1);if(t)throw console.error("ðŸ” DEBUG: Error checking envois_email table:",t),t;const{data:r,error:l}=await a.from("envois_email").select("*").eq("campagne_id",e.id).order("created_at",{ascending:!1});if(l)throw console.error("ðŸ” DEBUG: Main query error:",l),console.error("ðŸ” DEBUG: Error code:",l.code),console.error("ðŸ” DEBUG: Error message:",l.message),console.error("ðŸ” DEBUG: Error details:",l.details),console.error("ðŸ” DEBUG: Error hint:",l.hint),l;if(null==r||r.length,null==oe||oe.nombre_destinataires,null==oe||oe.nombre_envoyes,null==oe||oe.nombre_echecs,null==r||r.length,!oe||!(oe.nombre_envoyes>0||oe.nombre_echecs>0)||r&&0!==r.length||(console.error("ðŸš¨ CRITICAL: TRACKING INCONSISTENCY DETECTED!"),console.error("ðŸš¨ CRITICAL: Campaign indicates emails were sent but no individual records exist"),console.error("ðŸš¨ CRITICAL: This suggests a bug in the email sending system"),H({title:"âš ï¸ ProblÃ¨me de suivi dÃ©tectÃ©",description:"La campagne indique des envois mais aucun dÃ©tail individuel n'est enregistrÃ©. ExÃ©cutez le script SQL de correction.",variant:"destructive"})),null==r||r.length,r&&r.length>0){const e=r.map(e=>e.contact_id).filter(e=>null!=e),s=r.map(e=>e.projet_id).filter(e=>null!=e);let t=null;if(e.length>0){const{data:s,error:r}=await a.from("contact").select("identifiant, prenom, nom, email").in("identifiant",e);r?console.error("ðŸ” DEBUG: Contact fetch error:",r):(t=s,null==t||t.length)}let l=null;if(s.length>0){const{data:e,error:t}=await a.from("projets").select("\n              projet_id,\n              contact_id,\n              statut,\n              commercial,\n              origine,\n              contact:contact_id (\n                identifiant,\n                prenom,\n                nom,\n                email\n              )\n            ").in("projet_id",s);t?console.error("ðŸ” DEBUG: Project fetch error:",t):(l=e,null==l||l.length)}const n=r.map(e=>({...e,contact:(null==t?void 0:t.find(s=>s.identifiant===e.contact_id))||null,projet:(null==l?void 0:l.find(s=>s.projet_id===e.projet_id))||null}));return n.length,ue(n),void je(!0)}if(e.id,l)throw console.error("ðŸ” DEBUG: Main query error:",l),console.error("ðŸ” DEBUG: Error code:",l.code),console.error("ðŸ” DEBUG: Error message:",l.message),console.error("ðŸ” DEBUG: Error details:",l.details),console.error("ðŸ” DEBUG: Error hint:",l.hint),l;null==r||r.length,null==r||r[0],ue(r||[]),je(!0)}catch(s){console.error("ðŸ” DEBUG: Final error in loadCampaignDetails:",s),console.error("ðŸ” DEBUG: Campaign ID that failed:",e.id),console.error("ðŸ” DEBUG: Campaign name:",e.nom_campagne),H({title:"Erreur",description:"Impossible de charger les dÃ©tails de la campagne",variant:"destructive"})}finally{ve(!1)}})(s),disabled:ge,className:"gap-2",children:[e.jsx(R,{className:"h-4 w-4"}),"DÃ©tails"]})]})]})})},s.id)})}),0===De.length&&e.jsx(r,{children:e.jsxs(l,{className:"p-12 text-center",children:[e.jsx(S,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Aucune campagne trouvÃ©e"}),e.jsx("p",{className:"text-muted-foreground",children:"Aucun envoi groupÃ© ne correspond Ã  vos critÃ¨res de recherche."})]})}),e.jsx(h,{open:he,onOpenChange:je,children:e.jsxs(j,{className:"max-w-7xl max-h-[90vh] overflow-y-auto",children:[e.jsx(g,{children:e.jsxs(v,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-5 w-5"}),"DÃ©tails de la campagne : ",null==oe?void 0:oe.nom_campagne]})}),oe&&e.jsxs(p,{defaultValue:"overview",className:"w-full",children:[e.jsxs(N,{className:"grid w-full grid-cols-4",children:[e.jsx(f,{value:"overview",children:"Vue d'ensemble"}),e.jsxs(f,{value:"projects",children:["Projets (",[...new Set(xe.map(e=>e.projet_id).filter(Boolean))].length,")"]}),e.jsxs(f,{value:"emails",children:["Emails (",xe.length,")"]}),e.jsx(f,{value:"analytics",children:"Analytics"})]}),e.jsxs(b,{value:"overview",className:"space-y-6 mt-6",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsx(r,{children:e.jsxs(l,{className:"p-4 text-center",children:[e.jsx(U,{className:"h-8 w-8 text-blue-600 mx-auto mb-2"}),e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:oe.nombre_destinataires}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Destinataires"})]})}),e.jsx(r,{children:e.jsxs(l,{className:"p-4 text-center",children:[e.jsx(k,{className:"h-8 w-8 text-indigo-600 mx-auto mb-2"}),e.jsx("div",{className:"text-2xl font-bold text-indigo-600",children:[...new Set(xe.map(e=>e.projet_id).filter(Boolean))].length}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Projets"})]})}),e.jsx(r,{children:e.jsxs(l,{className:"p-4 text-center",children:[e.jsx(F,{className:"h-8 w-8 text-green-600 mx-auto mb-2"}),e.jsx("div",{className:"text-2xl font-bold text-green-600",children:oe.nombre_envoyes}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"EnvoyÃ©s"})]})}),e.jsx(r,{children:e.jsxs(l,{className:"p-4 text-center",children:[e.jsx(M,{className:"h-8 w-8 text-red-600 mx-auto mb-2"}),e.jsx("div",{className:"text-2xl font-bold text-red-600",children:oe.nombre_echecs}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Ã‰checs"})]})}),e.jsx(r,{children:e.jsxs(l,{className:"p-4 text-center",children:[e.jsx(G,{className:"h-8 w-8 text-purple-600 mx-auto mb-2"}),e.jsxs("div",{className:"text-2xl font-bold text-purple-600",children:[oe.nombre_destinataires>0?Math.round((oe.nombre_envoyes-oe.nombre_echecs)/oe.nombre_destinataires*100):0,"%"]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Taux SuccÃ¨s"})]})})]}),e.jsxs(r,{children:[e.jsx(_,{children:e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-5 w-5"}),"RÃ©partition des statuts d'email"]})}),e.jsx(l,{children:e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[{status:"envoye",label:"EnvoyÃ©s",color:"bg-green-500",count:xe.filter(e=>"envoye"===e.statut).length},{status:"ouvert",label:"Ouverts",color:"bg-blue-500",count:xe.filter(e=>"ouvert"===e.statut).length},{status:"clique",label:"Clics",color:"bg-purple-500",count:xe.filter(e=>"clique"===e.statut).length},{status:"echec",label:"Ã‰checs",color:"bg-red-500",count:xe.filter(e=>"echec"===e.statut).length}].map(({status:s,label:t,color:a,count:r})=>{const l=xe.length>0?r/xe.length*100:0;return e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:`inline-flex items-center justify-center w-16 h-16 rounded-full ${a} text-white font-bold text-lg mb-2`,children:r}),e.jsx("div",{className:"font-medium",children:t}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[l.toFixed(1),"%"]})]},s)})})})]}),e.jsxs(r,{children:[e.jsx(_,{children:e.jsx(w,{children:"Informations de la campagne"})}),e.jsx(l,{children:e.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-3",children:"ParamÃ¨tres"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"CrÃ©Ã©e le :"})," ",new Date(oe.created_at).toLocaleString("fr-FR")]}),e.jsxs("div",{children:[e.jsx("strong",{children:"ModifiÃ©e le :"})," ",new Date(oe.updated_at).toLocaleString("fr-FR")]}),oe.commercial&&e.jsxs("div",{children:[e.jsx("strong",{children:"Commercial :"})," ",oe.commercial]}),oe.statut_cible&&e.jsxs("div",{children:[e.jsx("strong",{children:"Statut ciblÃ© :"})," ",oe.statut_cible]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-3",children:"Template utilisÃ©"}),e.jsx("div",{className:"text-sm",children:$.find(e=>e.id===oe.template_id)?e.jsxs("div",{className:"p-3 bg-gray-50 rounded",children:[e.jsx("div",{children:e.jsx("strong",{children:null==(y=$.find(e=>e.id===oe.template_id))?void 0:y.nom})}),e.jsx("div",{className:"text-muted-foreground mt-1",children:null==(E=$.find(e=>e.id===oe.template_id))?void 0:E.sujet})]}):e.jsx("div",{className:"text-muted-foreground",children:"Template personnalisÃ© ou supprimÃ©"})})]})]})})]})]}),e.jsx(b,{value:"projects",className:"space-y-4 mt-6",children:e.jsxs("div",{className:"max-h-96 overflow-y-auto space-y-3",children:[[...new Set(xe.filter(e=>e.projet).map(e=>e.projet_id))].map(s=>{var t,a,n,i;const c=null==(t=xe.find(e=>e.projet_id===s))?void 0:t.projet,d=xe.filter(e=>e.projet_id===s);return c?e.jsx(r,{className:"border-l-4 border-l-blue-500",children:e.jsx(l,{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex justify-between items-start",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsxs("div",{className:"font-medium text-lg",children:[null==(a=c.contact)?void 0:a.prenom," ",null==(n=c.contact)?void 0:n.nom]}),e.jsxs(u,{variant:"outline",children:["Projet #",c.projet_id]}),e.jsx(u,{className:Be({statut:c.statut}),children:c.statut})]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:null==(i=c.contact)?void 0:i.email})]})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"Commercial:"})," ",c.commercial]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"Origine:"})," ",c.origine]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"Emails dans campagne:"})," ",d.length]})]}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"ðŸ“§ RÃ©sumÃ© des envois:"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2 text-xs",children:[e.jsxs("div",{className:"text-center p-2 bg-green-100 rounded",children:[e.jsx("div",{className:"font-medium text-green-800",children:d.filter(e=>"envoye"===e.statut).length}),e.jsx("div",{className:"text-green-600",children:"EnvoyÃ©s"})]}),e.jsxs("div",{className:"text-center p-2 bg-blue-100 rounded",children:[e.jsx("div",{className:"font-medium text-blue-800",children:d.filter(e=>"ouvert"===e.statut).length}),e.jsx("div",{className:"text-blue-600",children:"Ouverts"})]}),e.jsxs("div",{className:"text-center p-2 bg-purple-100 rounded",children:[e.jsx("div",{className:"font-medium text-purple-800",children:d.filter(e=>"clique"===e.statut).length}),e.jsx("div",{className:"text-purple-600",children:"Clics"})]}),e.jsxs("div",{className:"text-center p-2 bg-red-100 rounded",children:[e.jsx("div",{className:"font-medium text-red-800",children:d.filter(e=>"echec"===e.statut).length}),e.jsx("div",{className:"text-red-600",children:"Ã‰checs"})]})]})]})]})})},s):null}),0===[...new Set(xe.map(e=>e.projet_id).filter(Boolean))].length&&e.jsx(r,{children:e.jsxs(l,{className:"p-8 text-center",children:[e.jsx(k,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Aucun projet trouvÃ©"}),e.jsx("p",{className:"text-muted-foreground",children:"Les emails de cette campagne ne sont pas liÃ©s Ã  des projets spÃ©cifiques."})]})})]})}),e.jsx(b,{value:"emails",className:"space-y-4 mt-6",children:e.jsx("div",{className:"max-h-96 overflow-y-auto space-y-3",children:xe.map(s=>{var t,a;return e.jsx(r,{className:"border-l-4 border-l-gray-200",children:e.jsx(l,{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsxs("div",{className:"font-medium text-lg",children:[null==(t=s.contact)?void 0:t.prenom," ",null==(a=s.contact)?void 0:a.nom]}),e.jsx(u,{className:Ge(s.statut),children:s.statut})]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.destinataire})]}),e.jsx("div",{className:"text-right text-sm text-muted-foreground",children:s.date_envoi&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(A,{className:"h-3 w-3"}),new Date(s.date_envoi).toLocaleString("fr-FR")]})})]}),s.projet&&e.jsxs("div",{className:"bg-blue-50 p-3 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(k,{className:"h-4 w-4 text-blue-600"}),e.jsxs("span",{className:"font-medium text-blue-900",children:["Projet #",s.projet.projet_id]}),e.jsx(u,{variant:"outline",className:"text-xs",children:s.projet.statut})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm text-blue-800",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Commercial:"})," ",s.projet.commercial]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Origine:"})," ",s.projet.origine]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"font-medium text-sm",children:"ðŸ“§ Email envoyÃ©:"}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded border-l-2 border-gray-300",children:[e.jsx("div",{className:"font-medium text-sm mb-2",children:s.sujet}),s.contenu_html?e.jsx("div",{className:"text-sm prose prose-sm max-w-none",dangerouslySetInnerHTML:{__html:s.contenu_html}}):s.contenu_texte?e.jsx("div",{className:"text-sm whitespace-pre-wrap",children:s.contenu_texte}):e.jsx("div",{className:"text-sm text-muted-foreground italic",children:"Contenu non disponible"})]})]}),s.erreur_message&&e.jsxs("div",{className:"bg-red-50 p-3 rounded-lg border border-red-200",children:[e.jsxs("div",{className:"flex items-center gap-2 text-red-800",children:[e.jsx(T,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium text-sm",children:"Erreur d'envoi:"})]}),e.jsx("div",{className:"text-sm text-red-700 mt-1",children:s.erreur_message})]}),(s.date_ouverture||s.date_clic)&&e.jsxs("div",{className:"flex gap-4 text-xs text-muted-foreground",children:[s.date_ouverture&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(R,{className:"h-3 w-3"}),"Ouvert: ",new Date(s.date_ouverture).toLocaleString("fr-FR")]}),s.date_clic&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(S,{className:"h-3 w-3"}),"Clic: ",new Date(s.date_clic).toLocaleString("fr-FR")]})]})]})})},s.id)})})}),e.jsx(b,{value:"analytics",className:"space-y-6 mt-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs(r,{children:[e.jsx(_,{children:e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(P,{className:"h-5 w-5"}),"RÃ©partition des statuts"]})}),e.jsx(l,{children:e.jsx("div",{className:"space-y-3",children:[{status:"envoye",label:"EnvoyÃ©s avec succÃ¨s",color:"bg-green-500"},{status:"echec",label:"Ã‰checs",color:"bg-red-500"},{status:"ouvert",label:"Ouvertures",color:"bg-blue-500"},{status:"clique",label:"Clics",color:"bg-purple-500"}].map(({status:s,label:t,color:a})=>{const r=xe.filter(e=>e.statut===s).length,l=xe.length>0?r/xe.length*100:0;return e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${a}`}),e.jsx("span",{className:"text-sm",children:t})]}),e.jsxs("div",{className:"text-sm font-medium",children:[r," (",l.toFixed(1),"%)"]})]},s)})})})]}),e.jsxs(r,{children:[e.jsx(_,{children:e.jsx(w,{children:"Timeline d'envoi"})}),e.jsx(l,{children:e.jsxs("div",{className:"text-sm text-muted-foreground space-y-2",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"DÃ©marrage :"})," ",new Date(oe.created_at).toLocaleString("fr-FR")]}),e.jsxs("div",{children:[e.jsx("strong",{children:"DerniÃ¨re mise Ã  jour :"})," ",new Date(oe.updated_at).toLocaleString("fr-FR")]}),e.jsxs("div",{children:[e.jsx("strong",{children:"DurÃ©e totale :"})," ",Math.round((new Date(oe.updated_at).getTime()-new Date(oe.created_at).getTime())/6e4)," minutes"]})]})})]})]})})]})]})}),e.jsx(h,{open:pe,onOpenChange:Ne,children:e.jsxs(j,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(g,{children:e.jsxs(v,{className:"flex items-center gap-2",children:[e.jsx(O,{className:"h-5 w-5"}),"Historique des emails par projet - Campagne : ",null==oe?void 0:oe.nom_campagne]})}),_e.length>0?e.jsx("div",{className:"space-y-6 mt-6",children:_e.map((s,t)=>{var a,n,i;return e.jsxs(r,{className:"border-l-4 border-l-blue-500",children:[e.jsx(_,{children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsxs("div",{className:"font-medium text-lg",children:[null==(a=s.project.contact)?void 0:a.prenom," ",null==(n=s.project.contact)?void 0:n.nom]}),e.jsxs(u,{variant:"outline",children:["Projet #",s.project.projet_id]}),e.jsx(u,{className:Be({statut:s.project.statut}),children:s.project.statut})]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:null==(i=s.project.contact)?void 0:i.email})]}),e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>{var e;Ee(s.project),(async()=>{try{const e=[{date:(new Date).toISOString(),event:"delivered",subject:"Test email",campaign:"Test Campaign"},{date:new Date(Date.now()-864e5).toISOString(),event:"opened",subject:"Welcome email",campaign:"Welcome Campaign"}];return e.length,e}catch(e){throw console.error("ðŸ” DEBUG: Error in Brevo history API:",e),e}})(null==(e=s.project.contact)||e.email).then(e=>{H({title:"Historique Brevo chargÃ©",description:`${e.length} Ã©vÃ©nements trouvÃ©s`})}).catch(e=>{console.error("Error loading Brevo history:",e),H({title:"Erreur",description:"Impossible de charger l'historique Brevo",variant:"destructive"})})},children:[e.jsx(O,{className:"h-4 w-4 mr-2"}),"Historique Brevo"]})]})}),e.jsxs(l,{children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4 mb-4",children:[e.jsxs("div",{className:"text-center p-3 bg-gray-50 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-700",children:s.emailCount}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Total emails"})]}),e.jsxs("div",{className:"text-center p-3 bg-green-50 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:s.sentCount}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"EnvoyÃ©s"})]}),e.jsxs("div",{className:"text-center p-3 bg-blue-50 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:s.openedCount}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Ouverts"})]}),e.jsxs("div",{className:"text-center p-3 bg-purple-50 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-purple-600",children:s.clickedCount}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Clics"})]}),e.jsxs("div",{className:"text-center p-3 bg-red-50 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:s.errorCount}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Erreurs"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium",children:"DÃ©tails des emails :"}),e.jsx("div",{className:"max-h-96 overflow-y-auto space-y-3",children:s.emails.map((s,t)=>e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg border",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(u,{className:Ge(s.statut),children:s.statut}),e.jsx("span",{className:"text-sm font-medium",children:s.sujet})]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Destinataire: ",s.destinataire]})]}),e.jsx("div",{className:"text-xs text-muted-foreground text-right",children:s.date_envoi&&new Date(s.date_envoi).toLocaleString("fr-FR")})]}),(s.contenu_html||s.contenu_texte)&&e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"text-xs font-medium text-muted-foreground mb-2",children:"Contenu de l'email:"}),e.jsx("div",{className:"max-h-32 overflow-y-auto bg-white p-3 rounded border text-sm",children:s.contenu_html?e.jsx("div",{dangerouslySetInnerHTML:{__html:s.contenu_html}}):e.jsx("div",{className:"whitespace-pre-wrap",children:s.contenu_texte})})]}),(s.date_ouverture||s.date_clic)&&e.jsxs("div",{className:"flex gap-4 mt-2 text-xs text-muted-foreground",children:[s.date_ouverture&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(R,{className:"h-3 w-3"}),"Ouvert: ",new Date(s.date_ouverture).toLocaleString("fr-FR")]}),s.date_clic&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(S,{className:"h-3 w-3"}),"Clic: ",new Date(s.date_clic).toLocaleString("fr-FR")]})]})]},t))})]})]})]},t)})}):e.jsx(r,{children:e.jsxs(l,{className:"p-8 text-center",children:[e.jsx(O,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Aucun historique trouvÃ©"}),e.jsx("p",{className:"text-muted-foreground",children:"Cette campagne n'a pas d'historique d'emails par projet."})]})})]})})]})}function z(){const{user:t,loading:r}=y(),l=H(),[n,i]=s.useState([]),[c,d]=s.useState([]);s.useEffect(()=>{r||t||l("/login"),t&&o()},[t,r,l]);const o=async()=>{try{const{data:e}=await a.from("contact").select("*").order("created_at",{ascending:!1});d(e||[]),i([])}catch(e){console.error("Error loading campaigns data:",e)}};return e.jsx(E,{title:"Gestion des Campagnes",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-6 py-8",children:[e.jsxs("div",{className:"flex justify-between items-start mb-12",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-light text-slate-900 mb-2",children:"Campagnes"}),e.jsx("p",{className:"text-slate-600 text-base",children:"Gestion de vos campagnes email"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{className:"px-4 py-2 text-sm text-slate-600 hover:text-slate-900 border border-slate-300 rounded-lg hover:border-slate-400 transition-colors",children:"Exporter"}),e.jsx("button",{className:"px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:"Nouvelle campagne"})]})]}),e.jsx(V,{})]})})}export{z as default};
